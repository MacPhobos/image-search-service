# Database Migration Guide

> **Purpose**: Guide rails for safe database schema upgrades in image-search-service
> **Last Updated**: 2026-01-11
> **Based On**: Analysis of 28 migrations and 4 documented incidents

---

## Quick Reference

```bash
# Before creating any migration (MANDATORY)
uv run alembic heads          # Must show single head

# Create migration
make makemigrations           # Prompts for message, auto-generates

# Apply migrations
make migrate                  # Equivalent to: alembic upgrade head

# Troubleshooting
uv run alembic current        # Show current version
uv run alembic history        # View migration chain
uv run alembic upgrade head --sql  # Generate SQL (dry run)
```

---

## ðŸ”´ CRITICAL: Check for Multiple Heads BEFORE Creating Migrations

The most common migration failure in this project is the "Multiple Heads" error:

```bash
ERROR [alembic.util.messaging] Multiple head revisions are present for given
argument 'head'; please specify a specific target revision
```

**Prevention**: ALWAYS run this before `make makemigrations`:

```bash
$ uv run alembic heads
011_hash_dedup_fields (head)  # âœ… Single head = safe to proceed
```

If you see **multiple heads**, resolve them FIRST (see [Emergency: Multiple Heads](#emergency-multiple-heads)).

---

## ðŸ”´ Migration Creation Workflow

### Standard Workflow (Single Developer)

```bash
# 1. Pull latest changes
git pull origin main

# 2. Check migration state (MANDATORY)
uv run alembic heads          # Must show single head
uv run alembic current        # Know your starting point

# 3. Update SQLAlchemy models first
vim src/image_search_service/db/models.py

# 4. Create migration (auto-generates from model diff)
make makemigrations
# Enter migration message: add user_id to image_assets

# 5. Review generated migration
vim src/image_search_service/db/migrations/versions/<new_migration>.py

# 6. Test locally
make db-down && make db-up    # Fresh database
make migrate                  # Apply all migrations

# 7. Verify
uv run alembic current        # Should show new head
```

### Parallel Development Workflow

When multiple developers modify the database schema on different branches:

```bash
# Before merging feature branch to main:

# 1. Check main branch state
git checkout main && git pull
uv run alembic heads          # Note the current head

# 2. Check your feature branch
git checkout feature-branch
uv run alembic heads          # If different from main = potential conflict

# 3. If multiple heads will result after merge:
#    a. Coordinate with other developer
#    b. One of you creates merge migration (see Emergency section)
#    c. Test merge migration locally before pushing

# 4. After merge, verify single head
uv run alembic heads          # Must show single head
```

---

## ðŸŸ¡ Migration File Best Practices

### Always Include Docstrings

```python
"""Add user_id column to image_assets

Business Context:
- Multi-user support requires tracking asset ownership
- user_id references external auth system (Clerk)
- Nullable initially for backward compatibility with existing assets

Technical Notes:
- Index on user_id for query performance
- Foreign key constraint deferred until user service integration

Revision ID: 012_add_user_id_to_assets
Revises: 011_hash_dedup_fields
Create Date: 2026-01-11 14:30:00.000000
"""
```

### Make Operations Idempotent

```python
# ðŸ”´ BAD: Fails if run twice
def upgrade() -> None:
    op.create_index("idx_assets_user", "image_assets", ["user_id"])

def downgrade() -> None:
    op.drop_index("idx_assets_user")

# âœ… GOOD: Safe to re-run
def upgrade() -> None:
    op.create_index("idx_assets_user", "image_assets", ["user_id"],
                    if_not_exists=True)

def downgrade() -> None:
    op.drop_index("idx_assets_user", table_name="image_assets",
                  if_exists=True)
```

### Check Existence for Complex Operations

```python
from sqlalchemy import inspect

def upgrade() -> None:
    """Add column only if it doesn't exist."""
    conn = op.get_bind()
    inspector = inspect(conn)
    columns = [col['name'] for col in inspector.get_columns('image_assets')]

    if 'user_id' not in columns:
        op.add_column('image_assets',
                      sa.Column('user_id', sa.String(36), nullable=True))
```

---

## ðŸŸ¡ Naming Conventions

### Sequential Numbers (Main Branch)

```
{seq}_{action}_{object}[_qualifier].py

Examples:
011_hash_dedup_fields.py
012_add_user_id_to_assets.py
013_create_user_preferences_table.py
```

### Hex IDs (Feature Branches / Merges)

```
{hex}_{descriptive_name}.py

Examples (autogenerated):
f6a668d072bb_add_multi_prototype_scoring_fields.py
737ef70e7bab_merge_birth_date_and_index_migrations.py
```

**Rule**: Use sequential numbers for linear main branch work. Accept hex IDs from autogenerate when working on feature branches that may require merging.

---

## ðŸ”´ Emergency: Multiple Heads

### Symptoms

```bash
$ make migrate
ERROR: Multiple head revisions are present for given argument 'head'
```

### Diagnosis

```bash
# See all heads
$ uv run alembic heads
f6a668d072bb (head)
c1d2e3f4g5h6 (head)

# Find common ancestor
$ uv run alembic history --verbose | head -50
# Look for "branchpoint" indicator
```

### Resolution

```bash
# 1. Create merge migration
$ uv run alembic merge -m "merge parallel migrations" f6a668d072bb c1d2e3f4g5h6
# Generates: 737ef70e7bab_merge_parallel_migrations.py

# 2. Review generated merge migration
$ cat src/image_search_service/db/migrations/versions/737ef70e7bab_*.py
# Verify down_revision is tuple: ('f6a668d072bb', 'c1d2e3f4g5h6')

# 3. Test locally
$ make db-down && make db-up
$ make migrate

# 4. Verify single head restored
$ uv run alembic heads
737ef70e7bab (head)  # âœ… Success

# 5. Commit merge migration
$ git add src/image_search_service/db/migrations/versions/737ef70e7bab_*.py
$ git commit -m "fix(db): merge parallel migrations"
```

### Merge Migration Template

```python
"""Merge parallel migrations: feature_a and feature_b

Context:
- f6a668d072bb (feature_a): Added multi-prototype scoring fields
- c1d2e3f4g5h6 (feature_b): Added pending suggestion index
- Both created from parent 8d46a4ba4167 during parallel development

No schema conflicts - this merge reconciles the migration graph.

Revision ID: 737ef70e7bab
Revises: f6a668d072bb, c1d2e3f4g5h6
"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa

revision: str = '737ef70e7bab'
down_revision: Union[str, Sequence[str], None] = (
    'f6a668d072bb',
    'c1d2e3f4g5h6'
)
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

def upgrade() -> None:
    """Merge point - no schema changes needed."""
    pass

def downgrade() -> None:
    """Downgrade to multiple heads state."""
    pass
```

---

## ðŸ”´ Emergency: Broken Migration Reference

### Symptoms

```bash
$ make migrate
KeyError: '974bfe0f68ed'
```

### Diagnosis

```bash
# Find which migration has broken reference
$ grep -r "974bfe0f68ed" src/image_search_service/db/migrations/versions/
# Look for down_revision = "974bfe0f68ed"

# Verify revision doesn't exist
$ uv run alembic history | grep "974bfe0f68ed"
# (no output = doesn't exist)
```

### Resolution Options

**Option A: Edit migration (if NEVER deployed)**

```bash
# 1. Find correct parent
$ uv run alembic history --verbose
# Identify the actual parent revision

# 2. Edit broken migration
$ vim src/image_search_service/db/migrations/versions/<broken>.py
# Change: down_revision = "974bfe0f68ed"
# To:     down_revision = "<correct_parent>"

# 3. Test
$ make db-down && make db-up && make migrate
```

**Option B: Delete migration (if NEVER deployed and has no children)**

```bash
# 1. Verify no children depend on it
$ grep -r "<broken_revision_id>" src/image_search_service/db/migrations/versions/

# 2. Delete if safe
$ rm src/image_search_service/db/migrations/versions/<broken>.py

# 3. Verify chain
$ uv run alembic heads  # Should show valid head
```

**Option C: Create corrective migration (if DEPLOYED)**

```bash
# Cannot edit/delete deployed migrations
# Create new migration that achieves the same schema state
$ make makemigrations
# Enter: corrective migration for missing <description>
```

---

## ðŸŸ¡ Testing Migrations

### Local Testing Checklist

```bash
# 1. Clean database test
make db-down && make db-up
make migrate
uv run alembic current  # Verify head reached

# 2. Downgrade/upgrade test
uv run alembic downgrade -1
uv run alembic upgrade +1

# 3. Full rollback test (optional but recommended)
uv run alembic downgrade base
uv run alembic upgrade head
```

### Pre-Commit Validation

```bash
# Run before every commit with migration changes
make lint && make typecheck && make test
uv run alembic heads  # Verify single head
```

---

## ðŸ”´ Never Do These Things

| Action | Why It Breaks | What To Do Instead |
|--------|---------------|-------------------|
| Edit migration after deployment | Schema drift - DB doesn't match alembic_version | Create new migration |
| Delete migration after deployment | Breaks chain - new envs can't migrate | Keep file, create corrective migration |
| Skip migrations with `alembic stamp` | Silent schema drift | Fix issue, apply properly |
| Manually edit `generated.ts` types | Gets overwritten on regen | Update Pydantic models instead |
| Create migration without checking heads | Multiple heads error | Always run `alembic heads` first |

---

## ðŸŸ¢ PR Review Checklist for Migrations

When reviewing PRs that include migration files:

- [ ] Single migration file (or merge migration with explanation)
- [ ] `down_revision` matches current head
- [ ] Operations are idempotent (`if_exists`, `if_not_exists`)
- [ ] Docstring explains business context
- [ ] Both `upgrade()` and `downgrade()` implemented
- [ ] SQLAlchemy models updated to match migration
- [ ] Tests updated if API schemas changed
- [ ] Author confirmed local testing (`make db-down && db-up && migrate`)

---

## Historical Context

This guide is based on 4 documented incidents in this project:

1. **Dec 2025**: Broken `down_revision` reference (KeyError)
2. **Jan 8, 2026**: Multiple heads from parallel development (resolved with merge)
3. **Jan 10, 2026**: Merge migration referenced deleted revision
4. **Jan 10, 2026**: Second parallel development merge (cleanly resolved)

All incidents were resolved, but each required manual intervention. This guide aims to prevent recurrence through process and checklists.

---

## Related Documentation

- **Full Research**: `docs/research/alembic-migration-guide-rails-2026-01-11.md`
- **API Contract**: `docs/api-contract.md` (update if migrations affect API)
- **Main CLAUDE.md**: Root-level coordination guide
